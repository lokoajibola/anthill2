{% extends 'base.html' %}

{% block title %}View Scores - {{ school.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">View Student Scores</h4>
                    <a href="{% url 'academic:upload_scores' %}" class="btn btn-primary">Upload New Scores</a>
                </div>
                <div class="card-body">
                    <!-- Filter Form -->
                    <form method="get" class="mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Filter by Class</label>
                                    <select name="class_id" class="form-control">
                                        <option value="">All Classes</option>
                                        {% for class in classes %}
                                        <option value="{{ class.id }}" 
                                                {% if selected_class_id == class.id|stringformat:"i" %}selected{% endif %}>
                                            {{ class.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Filter by Subject</label>
                                    <select name="subject_id" class="form-control">
                                        <option value="">All Subjects</option>
                                        {% for subject in subjects %}
                                        <option value="{{ subject.id }}" 
                                                {% if selected_subject_id == subject.id|stringformat:"i" %}selected{% endif %}>
                                            {{ subject.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Filter by Exam Type</label>
                                    <select name="exam_type" class="form-control">
                                        <option value="">All Types</option>
                                        <option value="test" {% if selected_exam_type == 'test' %}selected{% endif %}>Test</option>
                                        <option value="assignment" {% if selected_exam_type == 'assignment' %}selected{% endif %}>Assignment</option>
                                        <option value="exam" {% if selected_exam_type == 'exam' %}selected{% endif %}>Exam</option>
                                        <option value="quiz" {% if selected_exam_type == 'quiz' %}selected{% endif %}>Quiz</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-outline-primary w-100">Apply Filters</button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Scores Table -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Class</th>
                                    <th>Subject</th>
                                    <th>Exam Type</th>
                                    <th>Score</th>
                                    <th>Max Score</th>
                                    <th>Percentage</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for score in scores %}
                                <tr>
                                    <td>{{ score.student.user.get_full_name }}</td>
                                    <td>{{ score.student.class_level.name|default:"-" }}</td>
                                    <td>{{ score.subject.name }}</td>
                                    <td>
                                        <span class="badge bg-{% if score.exam_type == 'exam' %}danger{% elif score.exam_type == 'test' %}warning{% else %}info{% endif %}">
                                            {{ score.exam_type|title }}
                                        </span>
                                    </td>
                                    <td><strong>{{ score.score }}</strong></td>
                                    <td>{{ score.max_score }}</td>
                                    <td>
                                        {% widthratio score.score score.max_score 100 as percentage %}
                                        <span class="badge bg-{% if percentage >= 70 %}success{% elif percentage >= 50 %}warning{% else %}danger{% endif %}">
                                            {{ percentage }}%
                                        </span>
                                    </td>
                                    <td>{{ score.date_taken }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">No scores found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary -->
                    {% if scores %}
                    <div class="mt-4 p-3 bg-light rounded">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h5>{{ scores.count }}</h5>
                                <small class="text-muted">Total Scores</small>
                            </div>
                            <div class="col-md-3">
                                <h5>
                                    {% with total=scores.count %}
                                    {% if total > 0 %}
                                        {% widthratio scores.count total 100 %}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                    {% endwith %}
                                </h5>
                                <small class="text-muted">Completion Rate</small>
                            </div>
                            <div class="col-md-3">
                                <h5>
                                    {% with subjects=scores.values_list('subject_id', flat=True).distinct %}
                                    {{ subjects.count }}
                                    {% endwith %}
                                </h5>
                                <small class="text-muted">Subjects</small>
                            </div>
                            <div class="col-md-3">
                                <h5>
                                    {% with classes=scores.values_list('student__class_level_id', flat=True).distinct %}
                                    {{ classes.count }}
                                    {% endwith %}
                                </h5>
                                <small class="text-muted">Classes</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% extends 'base.html' %}

{% block title %}{{ user.get_full_name }} - {{ school.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header with Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ user.get_full_name }}</h2>
        <div>
            <a href="{% url 'schools:manage_users' %}" class="btn btn-outline-secondary">Back to Users</a>
            {% if user_type == 'student' %}
            <a href="{% url 'academic:student_results' user.id %}" class="btn btn-primary">View Results</a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Profile Summary Card -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <!-- Editable Profile Picture -->
                    {% if can_edit %}
                    <form method="post" enctype="multipart/form-data" id="profile-picture-form">
                        {% csrf_token %}
                        <div class="position-relative d-inline-block">
                            <img id="profile-preview" src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}/static/default-avatar.png{% endif %}" 
                                 class="rounded-circle mb-3" width="150" height="150" style="object-fit: cover;">
                            <label for="profile-picture-input" class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle p-2 cursor-pointer">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="profile-picture-input" name="profile_picture" accept="image/*" class="d-none">
                        </div>
                    </form>
                    {% else %}
                    <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}/static/default-avatar.png{% endif %}" 
                         class="rounded-circle mb-3" width="150" height="150" style="object-fit: cover;">
                    {% endif %}
                    
                    <h4 class="mt-3">{{ user.get_full_name }}</h4>
                    <span class="badge bg-{% if user_type == 'teacher' %}primary{% elif user_type == 'student' %}success{% else %}warning{% endif %} mb-2">
                        {{ user.get_user_type_display }}
                    </span>
                    
                    <div class="mt-3 text-start">
                        <p><strong><i class="fas fa-envelope"></i> Email:</strong><br>{{ user.email }}</p>
                        <p><strong><i class="fas fa-phone"></i> Phone:</strong><br>{{ user.phone|default:"Not specified" }}</p>
                        {% if user_type == 'student' and profile.class_level %}
                        <p><strong><i class="fas fa-graduation-cap"></i> Class:</strong><br>{{ profile.class_level.name }}</p>
                        {% endif %}
                        {% if user_type == 'student' and profile.admission_number %}
                        <p><strong><i class="fas fa-id-card"></i> Admission No:</strong><br>{{ profile.admission_number }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if user_type == 'student' %}
                        
                        {% endif %}
                        {% if user_type == 'teacher' %}
                        
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Information Card -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Profile Information</h5>
                    {% if can_edit %}
                    <span class="badge bg-success">Editable</span>
                    {% else %}
                    <span class="badge bg-secondary">View Only</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if messages %}
                    <div class="mb-3">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if can_edit %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row">
                            <!-- Personal Information -->
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Personal Information</h6>
                            </div>
                            
                            {% if user_type == 'student' and 'class_level' in form.fields %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.class_level.label }}</label>
                                {{ form.class_level }}
                            </div>
                            {% endif %}
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.date_of_birth.label }}</label>
                                {{ form.date_of_birth }}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.blood_group.label }}</label>
                                {{ form.blood_group }}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.genotype.label }}</label>
                                {{ form.genotype }}
                            </div>

                            <!-- Contact Information -->
                            <div class="col-12 mt-4">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Contact Information</h6>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label class="form-label">{{ form.home_address.label }}</label>
                                {{ form.home_address }}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.emergency_contact.label }}</label>
                                {{ form.emergency_contact }}
                            </div>

                            <!-- Medical Information -->
                            <div class="col-12 mt-4">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Medical Information</h6>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label class="form-label">{{ form.allergies.label }}</label>
                                {{ form.allergies }}
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label class="form-label">{{ form.health_history.label }}</label>
                                {{ form.health_history }}
                            </div>

                            <!-- Academic & Activities -->
                            <div class="col-12 mt-4">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Academic & Activities</h6>
                            </div>
                            
                            {% if user_type == 'student' %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.sports_house.label }}</label>
                                {{ form.sports_house }}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.position.label }}</label>
                                {{ form.position }}
                            </div>
                            {% endif %}
                            
                            <div class="col-12 mb-3">
                                <label class="form-label">{{ form.extra_curricular.label }}</label>
                                {{ form.extra_curricular }}
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label class="form-label">{{ form.awards.label }}</label>
                                {{ form.awards }}
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label class="form-label">{{ form.disciplinary_record.label }}</label>
                                {{ form.disciplinary_record }}
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </div>
                    </form>
                    {% else %}
                    <!-- Read-only view -->
                    <div class="row">
                        <!-- Same structure as above but with display only -->
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">Personal Information</h6>
                        </div>
                        
                        {% if user_type == 'student' and profile.class_level %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><strong>Class:</strong></label>
                            <p>{{ profile.class_level.name }}</p>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><strong>Date of Birth:</strong></label>
                            <p>{{ profile.date_of_birth|default:"Not specified" }}</p>
                        </div>
                        
                        <!-- Continue with same structure for all fields -->
                        <!-- ... -->
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.cursor-pointer { cursor: pointer; }
.form-control { border-radius: 8px; }
.card { border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
</style>

<script>
// Profile picture preview
document.getElementById('profile-picture-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profile-preview').src = e.target.result;
            document.getElementById('profile-picture-form').submit();
        }
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}